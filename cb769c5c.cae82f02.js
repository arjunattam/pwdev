(window.webpackJsonp=window.webpackJsonp||[]).push([[72],{130:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return r})),a.d(t,"metadata",(function(){return c})),a.d(t,"rightToc",(function(){return s})),a.d(t,"default",(function(){return p}));var n=a(2),i=a(6),o=(a(0),a(149)),r={id:"auth",title:"Authentication"},c={unversionedId:"auth",id:"auth",isDocsHomePage:!1,title:"Authentication",description:"Playwright can be used to automate scenarios that require authentication.",source:"@site/docs/auth.md",slug:"/auth",permalink:"/pwdev/docs/auth",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/auth.md",version:"current",sidebar:"docs",previous:{title:"Multi-page scenarios",permalink:"/pwdev/docs/multi-pages"},next:{title:"Page Object Models",permalink:"/pwdev/docs/pom"}},s=[{value:"Automate logging in",id:"automate-logging-in",children:[]},{value:"Reuse authentication state",id:"reuse-authentication-state",children:[{value:"Cookies",id:"cookies",children:[]},{value:"Local storage",id:"local-storage",children:[]},{value:"Session storage",id:"session-storage",children:[]},{value:"Lifecycle",id:"lifecycle",children:[]},{value:"Example",id:"example",children:[]},{value:"API reference",id:"api-reference",children:[]}]},{value:"Multi-factor authentication",id:"multi-factor-authentication",children:[{value:"Persistent authentication",id:"persistent-authentication",children:[]},{value:"Lifecycle",id:"lifecycle-1",children:[]},{value:"API reference",id:"api-reference-1",children:[]}]}],l={rightToc:s};function p(e){var t=e.components,a=Object(i.a)(e,["components"]);return Object(o.a)("wrapper",Object(n.a)({},l,a,{components:t,mdxType:"MDXLayout"}),Object(o.a)("p",null,"Playwright can be used to automate scenarios that require authentication."),Object(o.a)("p",null,"Tests written with Playwright execute in isolated clean-slate environments called\n",Object(o.a)("a",Object(n.a)({parentName:"p"},{href:"/pwdev/docs/core-concepts#browser-contexts"}),"browser contexts"),". This isolation model\nimproves reproducibility and prevents cascading test failures. New browser\ncontexts can load existing authentication state. This eliminates the need to\nlogin in every context and speeds up test execution."),Object(o.a)("blockquote",null,Object(o.a)("p",{parentName:"blockquote"},"Note: This guide covers cookie/token-based authentication (logging in via the\napp UI). For ",Object(o.a)("a",Object(n.a)({parentName:"p"},{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Authentication"}),"HTTP authentication"),"\nuse ",Object(o.a)("a",Object(n.a)({parentName:"p"},{href:"/pwdev/docs/network#http-authentication"}),Object(o.a)("inlineCode",{parentName:"a"},"browser.newContext")),".")),Object(o.a)("ul",null,Object(o.a)("li",{parentName:"ul"},Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"#automate-logging-in"}),"Automate logging in")),Object(o.a)("li",{parentName:"ul"},Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"#reuse-authentication-state"}),"Reuse authentication state"),Object(o.a)("ul",{parentName:"li"},Object(o.a)("li",{parentName:"ul"},Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"#cookies"}),"Cookies")),Object(o.a)("li",{parentName:"ul"},Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"#local-storage"}),"Local storage")),Object(o.a)("li",{parentName:"ul"},Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"#session-storage"}),"Session storage")),Object(o.a)("li",{parentName:"ul"},Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"#lifecycle"}),"Lifecycle")),Object(o.a)("li",{parentName:"ul"},Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"#example"}),"Example")),Object(o.a)("li",{parentName:"ul"},Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"#api-reference"}),"API reference")))),Object(o.a)("li",{parentName:"ul"},Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"#multi-factor-authentication"}),"Multi-factor authentication"),Object(o.a)("ul",{parentName:"li"},Object(o.a)("li",{parentName:"ul"},Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"#persistent-authentication"}),"Persistent authentication")),Object(o.a)("li",{parentName:"ul"},Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"#lifecycle-1"}),"Lifecycle")),Object(o.a)("li",{parentName:"ul"},Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"#api-reference-1"}),"API reference"))))),Object(o.a)("h2",{id:"automate-logging-in"},"Automate logging in"),Object(o.a)("p",null,"The Playwright API can automate interaction with a login form. See\n",Object(o.a)("a",Object(n.a)({parentName:"p"},{href:"/pwdev/docs/input"}),"Input guide")," for more details."),Object(o.a)("p",null,"The following example automates login on GitHub. Once these steps are executed,\nthe browser context will be authenticated."),Object(o.a)("pre",null,Object(o.a)("code",Object(n.a)({parentName:"pre"},{className:"language-js"}),"const page = await context.newPage();\nawait page.goto('https://github.com/login');\n\n// Interact with login form\nawait page.click('text=Login');\nawait page.fill('input[name=\"login\"]', USERNAME);\nawait page.fill('input[name=\"password\"]', PASSWORD);\nawait page.click('text=Submit');\n// Verify app is logged in\n")),Object(o.a)("p",null,"These steps can be executed for every browser context. However, redoing login\nfor every test can slow down test execution. To prevent that, we will reuse\nexisting authentication state in new browser contexts."),Object(o.a)("h2",{id:"reuse-authentication-state"},"Reuse authentication state"),Object(o.a)("p",null,"Web apps use cookie-based or token-based authentication, where authenticated\nstate is stored as ",Object(o.a)("a",Object(n.a)({parentName:"p"},{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies"}),"cookies"),"\nor in ",Object(o.a)("a",Object(n.a)({parentName:"p"},{href:"https://developer.mozilla.org/en-US/docs/Web/API/Storage"}),"local storage"),".\nThe Playwright API can be used to retrieve this state from authenticated contexts\nand then load it into new contexts."),Object(o.a)("p",null,"Cookies and local storage state can be used across different browsers. They depend\non your application's authentication model: some apps might require both cookies\nand local storage."),Object(o.a)("p",null,"The following code snippets retrieve state from an authenticated page/context and\nload them into a new context."),Object(o.a)("h3",{id:"cookies"},"Cookies"),Object(o.a)("pre",null,Object(o.a)("code",Object(n.a)({parentName:"pre"},{className:"language-js"}),"// Get cookies and store as an env variable\nconst cookies = await context.cookies();\nprocess.env.COOKIES = JSON.stringify(cookies);\n\n// Set cookies in a new context\nconst deserializedCookies = JSON.parse(process.env.COOKIES)\nawait context.addCookies(deserializedCookies);\n")),Object(o.a)("h3",{id:"local-storage"},"Local storage"),Object(o.a)("p",null,"Local storage (",Object(o.a)("a",Object(n.a)({parentName:"p"},{href:"https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage"}),Object(o.a)("inlineCode",{parentName:"a"},"window.localStorage")),")\nis specific to a particular domain."),Object(o.a)("pre",null,Object(o.a)("code",Object(n.a)({parentName:"pre"},{className:"language-js"}),"// Get local storage and store as env variable\nconst localStorage = await page.evaluate(() => JSON.stringify(window.localStorage));\nprocess.env.LOCAL_STORAGE = localStorage;\n\n// Set local storage in a new context\nconst localStorage = process.env.LOCAL_STORAGE;\nawait context.addInitScript(storage => {\n  if (window.location.hostname === 'example.com') {\n    const entries = JSON.parse(storage);\n    Object.keys(entries).forEach(key => {\n      window.localStorage.setItem(key, entries[key]);\n    });\n  }\n}, localStorage);\n")),Object(o.a)("h3",{id:"session-storage"},"Session storage"),Object(o.a)("p",null,"Session storage (",Object(o.a)("a",Object(n.a)({parentName:"p"},{href:"https://developer.mozilla.org/en-US/docs/Web/API/Window/sessionStorage"}),Object(o.a)("inlineCode",{parentName:"a"},"window.sessionStorage")),")\nis specific to a particular domain."),Object(o.a)("pre",null,Object(o.a)("code",Object(n.a)({parentName:"pre"},{className:"language-js"}),"// Get session storage and store as env variable\nconst sessionStorage = await page.evaluate(() => JSON.stringify(sessionStorage));\nprocess.env.SESSION_STORAGE = sessionStorage;\n\n// Set session storage in a new context\nconst sessionStorage = process.env.SESSION_STORAGE;\nawait context.addInitScript(storage => {\n  if (window.location.hostname === 'example.com') {\n    const entries = JSON.parse(storage);\n    Object.keys(entries).forEach(key => {\n      window.sessionStorage.setItem(key, entries[key]);\n    });\n  }\n}, sessionStorage);\n")),Object(o.a)("h3",{id:"lifecycle"},"Lifecycle"),Object(o.a)("p",null,"Logging in via the UI and then reusing authentication state can be combined to\nimplement ",Object(o.a)("strong",{parentName:"p"},"login once and run multiple scenarios"),". The lifecycle looks like:"),Object(o.a)("ol",null,Object(o.a)("li",{parentName:"ol"},"Run tests (for example, with ",Object(o.a)("inlineCode",{parentName:"li"},"npm run test"),")."),Object(o.a)("li",{parentName:"ol"},"Login via UI and retrieve authentication state.",Object(o.a)("ul",{parentName:"li"},Object(o.a)("li",{parentName:"ul"},"In Jest, this can be executed in ",Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"https://jestjs.io/docs/en/configuration#globalsetup-string"}),Object(o.a)("inlineCode",{parentName:"a"},"globalSetup")),"."))),Object(o.a)("li",{parentName:"ol"},"In each test, load authentication state in ",Object(o.a)("inlineCode",{parentName:"li"},"beforeEach")," or ",Object(o.a)("inlineCode",{parentName:"li"},"beforeAll")," step.")),Object(o.a)("p",null,"This approach will also ",Object(o.a)("strong",{parentName:"p"},"work in CI environments"),", since it does not rely\non any external state."),Object(o.a)("h3",{id:"example"},"Example"),Object(o.a)("p",null,Object(o.a)("a",Object(n.a)({parentName:"p"},{href:"examples/authentication.js"}),"This example script")," logs in on GitHub.com with\nChromium, and then reuses the logged in cookie state in WebKit."),Object(o.a)("h3",{id:"api-reference"},"API reference"),Object(o.a)("ul",null,Object(o.a)("li",{parentName:"ul"},Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"/pwdev/docs/api#class-browsercontext"}),"class ",Object(o.a)("inlineCode",{parentName:"a"},"BrowserContext"))),Object(o.a)("li",{parentName:"ul"},Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"/pwdev/docs/api#browsercontextcookiesurls"}),Object(o.a)("inlineCode",{parentName:"a"},"browserContext.cookies"))),Object(o.a)("li",{parentName:"ul"},Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"/pwdev/docs/api#browsercontextaddcookiescookies"}),Object(o.a)("inlineCode",{parentName:"a"},"browserContext.addCookies"))),Object(o.a)("li",{parentName:"ul"},Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"/pwdev/docs/api#pageevaluatepagefunction-arg"}),Object(o.a)("inlineCode",{parentName:"a"},"page.evaluate"))),Object(o.a)("li",{parentName:"ul"},Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"/pwdev/docs/api#browsercontextaddinitscriptscript-arg"}),Object(o.a)("inlineCode",{parentName:"a"},"browserContext.addInitScript")))),Object(o.a)("h2",{id:"multi-factor-authentication"},"Multi-factor authentication"),Object(o.a)("p",null,"Accounts with multi-factor authentication (MFA) cannot be fully automated, and need\nmanual intervention. Persistent authentication can be used to partially automate\nMFA scenarios."),Object(o.a)("h3",{id:"persistent-authentication"},"Persistent authentication"),Object(o.a)("p",null,"Web browsers use a directory on disk to store user history, cookies, IndexedDB\nand other local state. This disk location is called the ",Object(o.a)("a",Object(n.a)({parentName:"p"},{href:"https://chromium.googlesource.com/chromium/src/+/master/docs/user_data_dir.md"}),"User data directory"),"."),Object(o.a)("p",null,"Note that persistent authentication is not suited for CI environments since it\nrelies on a disk location. User data directories are specific to browser types\nand cannot be shared across browser types."),Object(o.a)("p",null,"User data directories can be used with the ",Object(o.a)("inlineCode",{parentName:"p"},"launchPersistentContext")," API."),Object(o.a)("pre",null,Object(o.a)("code",Object(n.a)({parentName:"pre"},{className:"language-js"}),"const { chromium } = require('playwright');\n\nconst userDataDir = '/path/to/directory';\nconst context = await chromium.launchPersistentContext(userDataDir, { headless: false });\n// Execute login steps manually in the browser window\n")),Object(o.a)("h3",{id:"lifecycle-1"},"Lifecycle"),Object(o.a)("ol",null,Object(o.a)("li",{parentName:"ol"},"Create a user data directory on disk"),Object(o.a)("li",{parentName:"ol"},"Launch a persistent context with the user data directory and login the MFA account."),Object(o.a)("li",{parentName:"ol"},"Reuse user data directory to run automation scenarios.")),Object(o.a)("h3",{id:"api-reference-1"},"API reference"),Object(o.a)("ul",null,Object(o.a)("li",{parentName:"ul"},Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"/pwdev/docs/api#class-browsercontext"}),"class ",Object(o.a)("inlineCode",{parentName:"a"},"BrowserContext"))),Object(o.a)("li",{parentName:"ul"},Object(o.a)("a",Object(n.a)({parentName:"li"},{href:"/pwdev/docs/api#browsertypelaunchpersistentcontextuserdatadir-options"}),Object(o.a)("inlineCode",{parentName:"a"},"browserType.launchPersistentContext")))))}p.isMDXComponent=!0},149:function(e,t,a){"use strict";a.d(t,"a",(function(){return d}));var n=a(0),i=a.n(n);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function c(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var l=i.a.createContext({}),p=function(e){var t=i.a.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):c(c({},t),e)),a},u={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},b=i.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,o=e.originalType,r=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),b=p(a),d=n,O=b["".concat(r,".").concat(d)]||b[d]||u[d]||o;return a?i.a.createElement(O,c(c({ref:t},l),{},{components:a})):i.a.createElement(O,c({ref:t},l))}));function d(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=a.length,r=new Array(o);r[0]=b;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c.mdxType="string"==typeof e?e:n,r[1]=c;for(var l=2;l<o;l++)r[l]=a[l];return i.a.createElement.apply(null,r)}return i.a.createElement.apply(null,a)}b.displayName="MDXCreateElement"}}]);